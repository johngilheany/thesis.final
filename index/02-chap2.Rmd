---
output:
  pdf_document: default
  html_document: default
---
# Data Collection and Summary Statistics
```{r, echo=FALSE}
# List of packages required for this analysis
pkg <- c("dplyr", "ggplot2", "knitr", "bookdown", "devtools")
# Check if packages are not installed and assign the
# names of the packages not installed to the variable new.pkg
new.pkg <- pkg[!(pkg %in% installed.packages())]
# If there are any packages in the list that aren't installed,
# install them
if (length(new.pkg))
  install.packages(new.pkg, repos = "http://cran.rstudio.com")
```

## Data Aggregation
Data was collected for the iShares MSCI USA Equal Weighted ETF (EUSA), which tracks the parent index of the minimum volatiltiy index, and iShares Edge MSCI Min Vol USA ETF (USMV), which tracks the minimum volatility index, from Oct 31, 2011 to December 31, 2016 [@blackrock2017]. The iShares data contained this information for the two ETFs of interest for each constituent on the last trading day of every month. This included characteristics of each stock, such as: ticker, company name, asset class, weight of the stock relative to the entire index, price per share, number of shares, market value of the position, notional value of the position, sector, sedol number, isin number, exchange that the stock is listed on, and the month end date for the data. Each month-end dataset was individually downloaded, then aggregated to create the two separate raw data sets - one for EUSA and one for USMV. The data was then cleaned.

## Data Cleaning
After having a quick overview of the data, there were many issues with each respective dataset that needed to be fixed before the analysis could occur. Since USMV is a subset of EUSA, the issues were very similar, and those that existed in USMV, generally existed in USMV as well. The issues could be broken down into 3 main types: erroneous listed stock exchanges, problematic listed tickers, and price discrepancies due to issues like stock splits. Moreover, cash and cash related assets were removed from the data, as this dissertation focuses only on the stocks.  
 
### Non-US Exchanges
Looking at the unique exchanges of the data, it was observed that there were several foreign exchanges like the Swiss Exchange and the Mexican Stock Exchange. For example, in the EUSA data set, there were several foreign stock exchanges:
```{r}
load("~/thesis_final/data/usa.Rda")
# Print out unique exchanges in USA data set
head(unique(usa$exchange))
```
This did not make sense, given the ETF constituents are supposed to be US-focused, meaning they should be listed on US-based exchanges. Of the non-US exchange errors, they can be further broken up into two subgroups: companies that were incorretly listed overseas and are actually listed on US exchanges, and companies that also are actually listed on US exchanges but instead had their overseas exchange tickers listed. 

#### Mislabeled Exchanges
The first type of error involved companies that are actually listed on either the NYSE and NASDAQ, but were listed on a foreign exchange in the data and still had their US ticker used. One example was BAC (Bank of America) which is listed on the NYSE, but was listed on the Swiss Stock Exchange in the dataset: 
```{r, echo=FALSE, cache=TRUE}
load("~/thesis_final/data/usa_data.Rda")
BAC <- filter(usa, ticker == "BAC")
BAC <- select(BAC, ticker, name, weight, price, exchange, date)
```

```{r, echo=FALSE}
# Preview BAC data subset
head(BAC)
```
The price for BAC in the data set corresponded to the price of BAC in the NYSE, even though it was listed on the Swiss Exchange; BAC also did not corresponded to Bank of America on the Swiss Exchange. Thus, after several checks, it could be concluded that BAC in the data set was incorrectly listed on the Swiss Exchange, and should have been listed on the NYSE instead. Since the ticker was still correct and would be read in properly in the later stages of this paper, these cases were left as is and no changes were made.

#### Mislabeled Tickers
The second type of error stemmed from companies listed on foreign exchanges that are also listed on a US exchange in reality, but had their non-US ticker used in the data set. One example of this was Aflac, Inc. which was listed by its ticker "8686" on the Tokyo stock exchange:
```{r, echo=FALSE, cache=TRUE}
load("~/thesis_final/data/usa_data.Rda")
AFL <- filter(usa_data, Ticker == "8686")
AFL <- select(AFL, Ticker, Name, Weight...., Price, Exchange, Date)
AFL <- data.frame(AFL)
colnames(AFL) <- c("ticker", "name", "weight", "price", "exchange", "date")
```

```{r, echo=FALSE}
# Preview AFL data subset
head(AFL)
```

This immediately raised a red flag due to the numbers in the ticker. This numeric ticker corresponded to Aflac, Inc. on the Tokyo exchange, but when checking the recorded price of the stock for corresponding dates, it matched up with the Aflac, Inc. stock on the NYSE, with ticker "AFL". Thus, when this happened, each company was treated on a case-by-case basis. In this case, since the stock price corresponded to AFL, the ticker name was changed from "8686" to "AFL". This would ensure the data could be properly read in later on. 

### Unrecognized Tickers
The final general type of error in the data occured when the ticker incorrectly recorded in the data set. This was evaluated, once again, on a case-by-case basis, by observing which tickers were not recognize, and looking at the company name to understand why. Sometimes, the issue was very obvious. One example of a clear discrepancy was when the ticker had an asterisk at the end of it. After careful digging, the asterisk did not seem to mean anything, and it is unclear why some tickers contained it. One ticker was “AAPL*”:
```{r, echo=FALSE, cache=TRUE}
load("~/thesis_final/data/usa_data.Rda")
AAPL <- filter(usa_data, Ticker == "AAPL*")
AAPL <- select(AAPL, Ticker, Name, Weight...., Price, Date)
AAPL <- data.frame(AAPL)
colnames(AAPL) <- c("ticker", "name", "weight", "price", "date")
```

```{r, echo=FALSE}
# Preview AAPL data subset
head(AAPL)
```
This would cause future issues when reading the data in, because that ticker was not read in as "AAPL" due to the asterisk. This was fixed by simply removing the asterik from the ticker name. 

Another example of the ticker not being read in properly was when it contained numbers. Alflac was an example that was mentioned previously, but another one that applied here was "AG4" which was the ticker for Allergan. Since NYSE and NASDAQ tickers do not contain numbers, this was a clear issue:
```{r, echo=FALSE, cache=TRUE}
load("~/thesis_final/data/usa_data.Rda")
AGN <- filter(usa_data, Ticker == "AG4")
AGN <- select(AGN, Ticker, Name, Weight...., Exchange, Price, Date)
AGN <- data.frame(AGN)
colnames(AGN) <- c("ticker", "name", "weight", "exchange", "price", "date")
```

```{r, echo=FALSE}
# Preview AGN data subset
head(AGN)
```
After some research, it found that AG4 is the ticker for Allergan on the Deutsche Boerse AG Stock Exchange, but the prices corresponded to that of Allergan's on the NYSE. Thus, the AG4 ticker was changed to the ticker used for Allergan on the NYSE - AGN. Overall, though each category is unique, there has been a lot of overlap, and often times correcting one type of error would fix other errors too. For example here, many tickers that include numbers would lead to obvious errors, and this was often times because the ticker corresponded with the right company, just on a foreign exchange. 

### Price Discrepancies
The general methodology to ensure a change in ticker was appropriate was to check the price of the stock at a specific date, in the USA data set, and then compare it to the new ticker being assigned. If the price matched, the change was made. If the price did not match up, and was very different, research was performed to see if a stock-split might be the cause of this. If there was no evidence of a stock-split, then the stock further analyzed to see what the issue was. In addition to looking at when prices did not match up with tickers and companies for certain dates, monthly returns were calculated for each stock during the times they were in the index, and any abnormal returns (magnitude greater than 30% in one month) were look at manually. One example of this was Netflix's stock 7:1 stock split in 2015. The monthly data showed drastic fall in price from 656.94 on 2015-05-29 to a 114.31 on 2015-07-31, in just one month. This amounts to recorded loss of 82.5%:
```{r, echo=FALSE, cache=TRUE}
load("~/thesis_final/data/usa_data.Rda")
NFLX <- filter(usa_data, Ticker == "NFLX")
NFLX <- subset(NFLX, X1 >= 25241 & X1 < 25246) 
NFLX <- select(NFLX, Ticker, Name, Weight...., Exchange, Price, Date)
NFLX <- data.frame(NFLX)
colnames(NFLX) <- c("ticker", "name", "weight", "exchange", "price", "date")
```

```{r, echo=FALSE}
# Preview NFLX data subset
head(NFLX)
```
Since this surpassed the threshold set, it was look at in more detail. After some research, it was shown there was in fact a 7:1 stock split, so the price of the stock on 2015-07-31 was adjusted to 800.17, and the appropriate calculations were done. Thus, in this case, the ticker was left alone, but just the price was adjusted. 

Tickers and stock names that could not be determined were removed. In the end, “1015736” and "Orchard Supply Hardware Stores" were removed from the data set. These together accounted for less than 0.2% of the data for a given month-end date.

## EUSA and USMV Data Overview 
To get a sense of how the cleaned EUSA data looks, an overview is shown below:
```{r, echo=FALSE, cache=TRUE}
load("~/thesis_final/data/usa.Rda")
```

```{r, echo = FALSE}
library(dplyr)
head(arrange(usa, date))
```

Shown below are summary statistics for EUSA. 
```{r, echo=FALSE, cache=TRUE}
load("~/thesis_final/data/usa.Rda")
```

```{r, echo = FALSE}
usa_summ <- select(usa, name, asset.class, weight, sector, date)
summary(usa_summ)
```

To get a sense of how the cleaned USMV data looks, an overview is shown below:
```{r, echo=FALSE, cache=TRUE}
load("~/thesis_final/data/minvol.Rda")
```

```{r, echo = FALSE}
library(dplyr)
head(arrange(minvol, date))
```

Select summary statistics for USMV are shown below:
```{r, echo=FALSE, cache=TRUE}
load("~/thesis_final/data/minvol.Rda")
```

```{r, echo = FALSE}
minvol_summ <- select(minvol, name, asset.class, weight, sector, date)
summary(minvol_summ)
```

## EUSA and USMV Data Check
Thus, after cleaning all the data, a check was performed to test how accurate the data set actually was. This was done by comparing the weighted-returns from the index constructed from the data to the actual ETF returns on a monthly basis.
### Weights
The first thing to claculate and check were the weights of EUSA and USMV for all stocks on a monthly basis. If the data were perfect, these should add up to 1. However, as some tickers and cash were removed, and given tracking error between the ETF and index, this was not expected. 
However, something very close to 1 was expected. The monthly change in weights for EUSA is shown below.

```{r, echo = FALSE}
data(usa)
library(ggplot2)
usa_weight1 <- aggregate(weight ~ date, data=usa, FUN=sum)
summary(usa_weight1)
ggplot(usa_weight1) + geom_point(aes(date, weight)) + ggtitle("Sum of EUSA Weights")
```

As shown in the scatterplot above for EUSA, the weights are very close to 100%, generally within 0.2%. The minimum weight is 99.54%, while the largest weight is 100.21%. The mean weight is 99.79%. The monthly change in weights for USMV is shown below.

```{r, echo = FALSE}
data(minvol)
library(ggplot2)
usa_weight2 <- aggregate(weight ~ date, data=minvol, FUN=sum)
summary(usa_weight2)
ggplot(usa_weight2) + geom_point(aes(date, weight)) + ggtitle("Sum of USMV Weights")
```

As shown in the scatterplor above, the weights for USMV are very close to 100%, and no value exceeds 100%. The minimum weight is 99.58%, while the largest weight is 99.99%. The mean weight is 99.76%. Overall, these suggest the data is trustable.

### Comparing actual ETF returns to constructed ETF returns for EUSA and USMV
Before taking the data completely at face value, some additional checks were performed. This was accomplished by comparing the weighted returns of the constructed index we had for our data (looking at each constituent’s monthly return, multiplied by its weight), and comparing it to the actual ETF return. Thus, this provided a way to check how the weighted returns compared to the ETF returns for both EUSA and USMV. Though perfect correlation was not expected, a figure of at least 98% correlation between the weighted returns calculated and the ETF returns, on a monthly basis, was hoped for. The results for EUSA are shown below.

```{r, echo = FALSE}
load("~/thesis_final/data/returns1.Rda")
library(ggplot2)
# EUSA returns vs. EUSA constructed weighted returns
ggplot(returns1, aes(x=weighted_return, y=eusa_return)) + geom_point(shape=1) +  geom_smooth(method=lm) + ggtitle("EUSA returns vs. EUSA constructed weighted returns")

# Correlation between EUSA returns and EUSA constructed weighted returns
cor(returns1$eusa_return, returns1$weighted_return)
```
As shown, the returns have a correlation greater than 0.98.

Shown below is the data for USMV.

```{r}
# USA data
load("~/thesis_final/data/returns2.Rda")
library(ggplot2)
ggplot(returns2, aes(x=weighted_return, y=eminvol_return)) +
	geom_point(shape=1) +  geom_smooth(method=lm) + ggtitle("USMV returns vs. USMV constructed weighted returns")

# Correlation between USMV returns and USMV constructed weighted returns
cor(returns2$eminvol_return, returns2$weighted_return)
```
The correlation is 0.99. 

### Change in 5 largest holdings by average weight for EUSA and USMV
The next thing we want to see is how the top 5 largest holdings, by average weight, in each index have changed in weighting over time. For EUSA, the 5 largest holdings were AAPL, XOM, MSFT, GE, and JNJ. Their change in weights are shown below. 

```{r, echo = FALSE}
data(usa)
usa_weight3 <- aggregate(weight ~ ticker, data=usa, FUN=sum)
minvol_weight3 <- aggregate(weight ~ ticker, data=minvol, FUN=sum)

usa_sub1 <- filter(usa, ticker == "AAPL" | ticker == "XOM" | ticker == "MSFT" | ticker == "GE" | ticker == "JNJ")
usa_sub1 <- select(usa_sub1, date, ticker, weight)

library(ggplot2)

ggplot() + 
	geom_line(data = filter(usa_sub1, ticker == "AAPL"), aes(x = date, y = weight, color = "AAPL")) +
	geom_line(data = filter(usa_sub1, ticker == "XOM"), aes(x = date, y = weight, color = "XOM"))  +
	geom_line(data = filter(usa_sub1, ticker == "MSFT"), aes(x = date, y = weight, color = "MSFT"))  +
	geom_line(data = filter(usa_sub1, ticker == "GE"), aes(x = date, y = weight, color = "GE"))  +
	geom_line(data = filter(usa_sub1, ticker == "JNJ"), aes(x = date, y = weight, color = "JNJ"))  +
	xlab('date') + ylab('weight') + ggtitle('Change in Weights of Top 5 EUSA Holdings')
```

Shown above, for EUSA, are some very interesting findings. The weights of the 5 companies are all very high, then suddenly all spike. Verifying this in the data, showed that for all 5 companies, holdings dropped significantly between 2015-07-31 and 2015-08-31. The reason for this is not entirely clear, but the general ETF started performing poorly around this time too. In July of 2015 the price per share was 45.20, then it dropped to 42.60 the following month, and dropped again to 40.50 in August 2015. Perhaps these large companies were doing poorly, and MSCI decided to try underweighting them. 

For USMV, the 5 largest holdings were VZ, T, ADP, JNJ, and MCD. Their change in weights are shown below. As we can see below, with the exception of Verizon, the holdings generally remain between 1 and 1.6 percent of the overall portfolio.

```{r, echo = FALSE}
minvol_sub1 <- filter(minvol, ticker == "VZ" | ticker == "T" | ticker == "ADP" | ticker == "JNJ" | ticker == "MCD")
minvol_sub1 <- select(minvol_sub1, date, ticker, weight)

library(ggplot2)

ggplot() + 
	geom_line(data = filter(minvol_sub1, ticker == "VZ"), aes(x = date, y = weight, color = "VZ")) +
	geom_line(data = filter(minvol_sub1, ticker == "T"), aes(x = date, y = weight, color = "T"))  +
	geom_line(data = filter(minvol_sub1, ticker == "ADP"), aes(x = date, y = weight, color = "ADP"))  +
	geom_line(data = filter(minvol_sub1, ticker == "JNJ"), aes(x = date, y = weight, color = "JNJ"))  +
	geom_line(data = filter(minvol_sub1, ticker == "MCD"), aes(x = date, y = weight, color = "MCD"))  +
	xlab('date') + ylab('weight') + ggtitle('Change in Weights of Top 5 USMV Holdings')

```
