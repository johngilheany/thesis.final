```{r include_packages_2, include = FALSE}
# This chunk ensures that the thesisdown package is
# installed and loaded. This thesisdown package includes
# the template files for the thesis and also two functions
# used for labeling and referencing
if(!require(devtools))
  install.packages("devtools", repos = "http://cran.rstudio.com")
if(!require(dplyr))
    install.packages("dplyr", repos = "http://cran.rstudio.com")
if(!require(ggplot2))
    install.packages("ggplot2", repos = "http://cran.rstudio.com")
if(!require(ggplot2))
    install.packages("bookdown", repos = "http://cran.rstudio.com")
if(!require(thesisdown)){
  library(devtools)
  devtools::install_github("ismayc/thesisdown")
  }
library(thesisdown)
flights <- read.csv("data/flights.csv")
```

# Data Analysis
## Changes in Largest Holdings by Average Weight in Minimum Volatility Index
The top 5 largest holdings in the Minimum Volatility Index by average weight are Verizon, AT&T, Automatic Data Processing, Johnson & Johnson, and McDonald's. 

```{r, echo = FALSE, include=FALSE}
load("~/thesis_final/data/minvol.Rda")

minvol_topweight <- aggregate(weight ~ ticker, data=minvol, FUN=sum)
minvol_topweight <- arrange(minvol_topweight, desc(weight))
minvol_topweight$weight <- minvol_topweight$weight/63
minvol_topweight$rank <- seq.int(nrow(minvol_topweight))
```

```{r fig.cap = paste("Top 5 Holdings in Minimum Volatility Index over Time by Average Weight"), echo=FALSE, include=FALSE}

minvol_topweight <- select(minvol_topweight, rank, ticker, weight)
minvol_topweight <- minvol_topweight[1:5,]

kable(minvol_topweight, 
      col.names = c("Rank", "Ticker", "Average Weight"),
      caption = "Top 5 Holdings in the Minimum Volatility Index over Time by Average Weight",
      longtable = TRUE,
      booktabs = TRUE)
```

```{r, echo = FALSE, include=FALSE}
load("~/thesis_final/data/minvol.Rda")
minvol_sub1 <- filter(minvol, ticker == "VZ" | ticker == "T" | ticker == "ADP" | ticker == "JNJ" | ticker == "MCD")
minvol_sub1 <- select(minvol_sub1, date, ticker, weight)

library(ggplot2)

holdings2<- ggplot() + 
	geom_line(data = filter(minvol_sub1, ticker == "VZ"), aes(x = date, y = weight, color = "VZ")) +
	geom_line(data = filter(minvol_sub1, ticker == "T"), aes(x = date, y = weight, color = "T"))  +
	geom_line(data = filter(minvol_sub1, ticker == "ADP"), aes(x = date, y = weight, color = "ADP"))  +
	geom_line(data = filter(minvol_sub1, ticker == "JNJ"), aes(x = date, y = weight, color = "JNJ"))  +
	geom_line(data = filter(minvol_sub1, ticker == "MCD"), aes(x = date, y = weight, color = "MCD"))  +
	xlab('date') + ylab('weight') + ggtitle('Change in Weights of the Top 5 Holdings in the Minimum Volatility Index over Time')
```

``` {r fig.cap = paste("The 5 largest holdings of the Minimum Volatility Index are VZ, T, ADP, JNJ, and MCD. Since the index's inception, these stocks have generally remained between a weight of 1.3% and 1.7% of the overall portfolio, with the exception of Verizon, which reached around 2% in 2014."), echo=FALSE}
plot(holdings2)
```

## Sector Weights
Sector weights were calculated over time for both the US Equal Weight and the Minimum Volatility Index. This was done to get a sense of what industries may be inherently more "low-risk" as well as checking to make sure the data is resilient, and each sector weighting in the Minimum Volatility Index is within 5% of the US Equal Weight Index, as specified by the Barra Optimizer. 

```{r, echo=FALSE}
load("~/thesis_final/data/usa_percent.Rda")
load("~/thesis_final/data/minvol_percent.Rda")
library(ggplot2)

## Energy
Eng1 <- usa_percent[which(usa_percent$sector_name=="Energy"), ]
Eng2 <- minvol_percent[which(minvol_percent$sector_name=="Energy"), ]
ggplot(Eng1, aes(date, percent, colour = "USA")) + geom_line() +  
ggtitle("EUSA and USMV Energy Sector Weights") + xlab("Time") + ylab("Sector Weight") +
geom_line(data = Eng2, aes(x=date, y=percent, colour="Min Vol"),show.legend = TRUE)

## Finacials
Fin1 <- usa_percent[which(usa_percent$sector_name=="Financials"), ]
Fin2 <- minvol_percent[which(minvol_percent$sector_name=="Financials"), ]
ggplot(Fin1, aes(date, percent, colour = "USA")) + geom_line() + 
ggtitle("EUSA and USMV Financial Sector Weights") + xlab("Time") + 
ylab("Sector Weight") + 
geom_line(data = Fin2, aes(x=date, y=percent, colour="Min Vol"),show.legend = TRUE)

## Consumer Staples
ConStap1 <- usa_percent[which(usa_percent$sector_name=="Consumer Staples"), ]
ConStap2 <- minvol_percent[which(minvol_percent$sector_name=="Consumer Staples"), ]
ggplot(ConStap1, aes(date, percent, colour = "USA")) + geom_line() + 
ggtitle("EUSA and USMV Consumer Staples Sector Weights") + xlab("Time") + 
ylab("Sector Weight") + geom_line(data = ConStap2, aes(x=date, y=percent, 
colour="Min Vol"),show.legend = TRUE)

## Consumer Discretionary
ConDis1 <- usa_percent[which(usa_percent$sector_name=="Consumer Discretionary"), ]
ConDis2 <- minvol_percent[which(minvol_percent$sector_name=="Consumer Discretionary"), ]
ggplot(ConDis1, aes(date, percent, colour = "USA")) + geom_line() + 
ggtitle("EUSA and USMV Consumer Discretionary Sector Weights") + xlab("Time") + 
ylab("Sector Weight") + geom_line(data = ConDis2, aes(x=date, y=percent, 
colour="Min Vol"),show.legend = TRUE)

## Health Care
Health1 <- usa_percent[which(usa_percent$sector_name=="Health Care"), ]
Health2 <- minvol_percent[which(minvol_percent$sector_name=="Health Care"), ]
ggplot(Health1, aes(date, percent, colour = "USA")) + geom_line() + 
ggtitle("EUSA and USMV Health Care Sector Weights") + xlab("Time") + 
ylab("Sector Weight") + geom_line(data = Health2, aes(x=date, y=percent, 
colour="Min Vol"),show.legend = TRUE)

## Industrials
Ind1 <- usa_percent[which(usa_percent$sector_name=="Industrials"), ]
Ind2 <- minvol_percent[which(minvol_percent$sector_name=="Industrials"), ]
ggplot(Ind1, aes(date, percent, colour = "USA")) + geom_line() + 
ggtitle("EUSA and USMV Industrials Sector Weights") + xlab("Time") + 
ylab("Sector Weight") + geom_line(data = Ind2, aes(x=date, y=percent, 
colour="Min Vol"),show.legend = TRUE)

## Information Technology
IT1 <- usa_percent[which(usa_percent$sector_name=="Information Technology"), ]
IT2 <- minvol_percent[which(minvol_percent$sector_name=="Information Technology"), ]
ggplot(IT1, aes(date, percent, colour = "USA")) + geom_line() + 
ggtitle("EUSA and USMV Information Technology Sector Weights") + 
xlab("Time") + ylab("Sector Weight") + geom_line(data = IT2, aes(x=date, y=percent,
colour="Min Vol"),show.legend = TRUE)

## Materials
Mat1 <- usa_percent[which(usa_percent$sector_name=="Materials"), ]
Mat2 <- minvol_percent[which(minvol_percent$sector_name=="Materials"), ]
ggplot(Mat1, aes(date, percent, colour = "USA")) + geom_line() + 
ggtitle("EUSA and USMV Materials Sector Weights") + xlab("Time") + 
ylab("Sector Weight") + geom_line(data = Mat2, aes(x=date, y=percent, 
colour="Min Vol"),show.legend = TRUE)

## Utilites
Util1 <- usa_percent[which(usa_percent$sector_name=="Utilities"), ]
Util2 <- minvol_percent[which(minvol_percent$sector_name=="Utilities"), ]
ggplot(Util1, aes(date, percent, colour = "USA")) + geom_line() + 
ggtitle("EUSA and USMV Utilities Sector Weights") + xlab("Time") + 
ylab("Sector Weight") + geom_line(data = Util2, aes(x=date, y=percent, 
colour="Min Vol"),show.legend = TRUE)

## Telecommunication Services
Telecom1 <- usa_percent[which(usa_percent$sector_name=="Telecommunications"), ]
Telecom2 <- minvol_percent[which(minvol_percent$sector_name=="Telecommunications"), ]
ggplot(Telecom1, aes(date, percent, colour = "USA")) + geom_line() + 
ggtitle("EUSA and USMV Telecommunications Sector Weights") + 
xlab("Time") + ylab("Sector Weight") + geom_line(data = Telecom2, aes(x=date, 
y=percent, colour="Min Vol"),show.legend = TRUE)
```

## Trailing Volatilities 
Data was collected from 10/31/2010 to 12/30/2016, from Wharton Research Data Services (WRDS) for the 908 historical constituents of the USA Equal Weight (EUSA) ETF, of which the Minimum Volatility Index is derived. Each tickers' 252-day (annual) trailing volatility was calculated, and a month end spagetti plot was produced for stocks in the Minimum Volatility Index, and the remainder of the stock comprising the US Equal Weight Index, to get a relative sense of each group's volatility attributes. The stocks comprising the Minimum Volatility Index generally had a lower volatility than those in the US Equal Weight Index.

```{r, echo = FALSE}
library(ggplot2)
load("~/thesis_final/data/monthly_data.Rda")

usa_vol <-filter(monthly_data, index_now == 0)
summary(usa_vol$volatility)

us_volplot <- ggplot(usa_vol, aes(date, volatility, group = ticker)) + geom_line() + ggtitle("52-Week Trailing Volatility for Stocks in the US Equal Weight Index") + labs(x="Date", y="52-week Trailing Volatility")
```

``` {r fig.cap = paste("The 52-week trailing volatilities for stocks in the US Equal Weight Index ranged from 0.00492 to 87.37030, with a mean value of 1.44738."), echo=FALSE}
plot(us_volplot)
```

```{r, echo = FALSE}
library(ggplot2)
load("~/thesis_final/data/monthly_data.Rda")

minvol_vol <-filter(monthly_data, index_now == 1)
summary(minvol_vol$volatility)

minvol_volplot <- ggplot(minvol_vol, aes(date, volatility, group = ticker)) + geom_line() + ggtitle("52-Week Trailing Volatility for Stocks in the Minimum Volatility Index") + labs(x="Date", y="52-week Trailing Volatility")
```

``` {r fig.cap = paste("The 52-week trailing volatilities for stocks in the Minimum Volatility Index ranged from 0.03085 to 34.20974, with a mean value of 1.40784."), echo=FALSE}
plot(minvol_volplot)
```

## Trailing Betas 
Data was collected from 10/31/2010 to 12/30/2016, from Wharton Research Data Services (WRDS) for the 908 historical constituents of the USA Equal Weight (EUSA) ETF, of which the Minimum Volatility Index is derived. Each tickers' 252-day (annual) trailing beta was calculated, and a month end spagetti plot was produced for stocks in the Minimum Volatility Index, and the remainder of the stock comprising the US Equal Weight Index, to get a relative sense of each group's volatility attributes. Generally, the stocks comprising the Minimum Volatility Index had a lower beta than those in the US Equal Weight Index.

```{r, echo = FALSE}
library(ggplot2)
load("~/thesis_final/data/monthly_data.Rda")

usa_beta <-filter(monthly_data, index_now == 0)
summary(usa_beta$beta)

usa_beta_plot <- ggplot(usa_beta, aes(date, beta, group = ticker)) + geom_line() + ggtitle("52-Week Trailing Beta for Stocks in the US Equal Weight Index") + labs(x="Date", y="52-week Trailing Beta")
```

``` {r fig.cap = paste("The 52-week trailing betas for stocks in the US Equal Weight Index ranged from -4.9037 to 6.4952, with a mean value of 1.1505"), echo=FALSE}
plot(usa_beta_plot)
```

```{r, echo = FALSE}
library(ggplot2)
load("~/thesis_final/data/monthly_data.Rda")

minvol_beta <-filter(monthly_data, index_now == 1)
summary(minvol_beta$beta)

minvol_beta_plot <- ggplot(minvol_beta, aes(date, beta, group = ticker)) + geom_line() + ggtitle("52-Week Trailing Beta for Stocks in the Minimum Volatility Index") + labs(x="Date", y="52-week Trailing Beta")
```

``` {r fig.cap = paste("The 52-week trailing betas for stocks in the Minimum Volatility Index ranged from -0.2473 to 3.2021, with a mean value of 0.7856"), echo=FALSE}
plot(minvol_beta_plot)
```

## Price to Book Ratios 
Data was collected from 10/31/2010 to 12/30/2016, from Wharton Research Data Services (WRDS) for the 908 historical constituents of the USA Equal Weight (EUSA) ETF, of which the Minimum Volatility Index is derived. Each tickers' Price to Book ratio was calculated, and a month end spagetti plot was produced for stocks in the Minimum Volatility Index, and the remainder of the stock comprising the US Equal Weight Index, to get a relative sense of each group's volatility attributes. The stocks comprising the Minimum Volatility Index generally had a similar price to book ratio when compared those in the US Equal Weight Index.

```{r, echo = FALSE}
library(ggplot2)
load("~/thesis_final/data/monthly_data.Rda")

usa_pbr <-filter(monthly_data, index_now == 0)
summary(usa_pbr$price_to_book)

usa_pbr_plot <- ggplot(usa_pbr, aes(date, price_to_book, group = ticker)) + geom_line() + ggtitle("Price to Book Ratios for Stocks in the US Equal Weight Index") + labs(x="Date", y="Price to Book Ratio")
```

``` {r fig.cap = paste("The price to book ratios for stocks in the US Equal Weight Index ranged from 0.2829 to 96.1338, with a mean value of 4.1138"), echo=FALSE}
plot(usa_pbr_plot)
```

```{r, echo = FALSE}
library(ggplot2)
load("~/thesis_final/data/monthly_data.Rda")

minvol_pbr <-filter(monthly_data, index_now == 1)
summary(minvol_pbr$price_to_book)

minvol_pbr_plot <- ggplot(minvol_pbr, aes(date, price_to_book, group = ticker)) + geom_line() + ggtitle("Price to Book Ratios for Stocks in the Minimum Volatility Index") + labs(x="Date", y="Price to Book Ratio")
```

``` {r fig.cap = paste("The price to book ratios for stocks in the Minimum Volatility Index ranged from 0.2829 to 76.4406, with a mean value of 5.0907"), echo=FALSE}
plot(minvol_pbr_plot)
```
