```{r include_packages_2, include = FALSE}
# This chunk ensures that the thesisdown package is
# installed and loaded. This thesisdown package includes
# the template files for the thesis and also two functions
# used for labeling and referencing
if(!require(devtools))
  install.packages("devtools", repos = "http://cran.rstudio.com")
if(!require(dplyr))
    install.packages("dplyr", repos = "http://cran.rstudio.com")
if(!require(ggplot2))
    install.packages("ggplot2", repos = "http://cran.rstudio.com")
if(!require(ggplot2))
    install.packages("bookdown", repos = "http://cran.rstudio.com")
if(!require(thesisdown)){
  library(devtools)
  devtools::install_github("ismayc/thesisdown")
  }
library(thesisdown)
flights <- read.csv("data/flights.csv")
```

# Data Analysis
## Change in Largest Holdings Over Time
The top 5 largest holdings in the US Equal Weight Index by average weight are Apple, Exxon Mobil, Microsoft, General Electric, and Johnson & Johnson.

```{r, echo = FALSE}
load("~/thesis_final/data/usa.Rda")

usa_topweight <- aggregate(weight ~ ticker, data=usa, FUN=sum)
usa_topweight <- arrange(usa_topweight, desc(weight))
usa_topweight$weight <- usa_topweight$weight/63
usa_topweight$rank <- seq.int(nrow(usa_topweight))
```

```{r fig.cap = paste("Top 5 Holdings in US Equal Weight Index over Time by Average Weight"), echo=FALSE}

usa_topweight <- select(usa_topweight, rank, ticker, weight)
usa_topweight <- usa_topweight[1:5,]

kable(usa_topweight, 
      col.names = c("Rank", "Ticker", "Average Weight"),
      caption = "Top 5 Holdings in the US Equal Weight Index over Time by Average Weight",
      longtable = TRUE,
      booktabs = TRUE)
```

```{r, echo = FALSE}
load("~/thesis_final/data/usa.Rda")
load("~/thesis_final/data/minvol.Rda")

usa_sub1 <- filter(usa, ticker == "AAPL" | ticker == "XOM" | ticker == "MSFT" | ticker == "GE" | ticker == "JNJ")
usa_sub1 <- select(usa_sub1, date, ticker, weight)

library(ggplot2)

holdings1<- ggplot() + 
	geom_line(data = filter(usa_sub1, ticker == "AAPL"), aes(x = date, y = weight, color = "AAPL")) +
	geom_line(data = filter(usa_sub1, ticker == "XOM"), aes(x = date, y = weight, color = "XOM"))  +
	geom_line(data = filter(usa_sub1, ticker == "MSFT"), aes(x = date, y = weight, color = "MSFT"))  +
	geom_line(data = filter(usa_sub1, ticker == "GE"), aes(x = date, y = weight, color = "GE"))  +
	geom_line(data = filter(usa_sub1, ticker == "JNJ"), aes(x = date, y = weight, color = "JNJ"))  +
	xlab('date') + ylab('weight') + ggtitle('Average Weight Change of  Top 5 Holdings in the US Equal Weight Index')
```

``` {r topholdingsusa, fig.cap = paste("The 5 largest holdings are AAPLE, XOM, MSFT, GE, and JNJ. The weights of the 5 companies start off very high, each as a few percent of the overall index, then suddenly all drop significantly to a fraction of a percent after 2015-08-31. After verifying this with iShares and MSCI, it was discovered that this due to change in the weighting mechanism."), echo=FALSE}
plot(holdings1)
```
\clearpage 

The top 5 largest holdings in the Minimum Volatility Index by average weight are Verizon, AT&T, Automatic Data Processing, Johnson & Johnson, and McDonald's. 

```{r, echo = FALSE}
load("~/thesis_final/data/minvol.Rda")

minvol_topweight <- aggregate(weight ~ ticker, data=minvol, FUN=sum)
minvol_topweight <- arrange(minvol_topweight, desc(weight))
minvol_topweight$weight <- minvol_topweight$weight/63
minvol_topweight$rank <- seq.int(nrow(minvol_topweight))
```

```{r fig.cap = paste("Top 5 Holdings in Minimum Volatility Index over Time by Average Weight"), echo=FALSE}

minvol_topweight <- select(minvol_topweight, rank, ticker, weight)
minvol_topweight <- minvol_topweight[1:5,]

kable(minvol_topweight, 
      col.names = c("Rank", "Ticker", "Average Weight"),
      caption = "Top 5 Holdings in the Minimum Volatility Index over Time by Average Weight",
      longtable = TRUE,
      booktabs = TRUE)
```

```{r, echo = FALSE}
load("~/thesis_final/data/minvol.Rda")
minvol_sub1 <- filter(minvol, ticker == "VZ" | ticker == "T" | ticker == "ADP" | ticker == "JNJ" | ticker == "MCD")
minvol_sub1 <- select(minvol_sub1, date, ticker, weight)

library(ggplot2)

holdings2<- ggplot() + 
	geom_line(data = filter(minvol_sub1, ticker == "VZ"), aes(x = date, y = weight, color = "VZ")) +
	geom_line(data = filter(minvol_sub1, ticker == "T"), aes(x = date, y = weight, color = "T"))  +
	geom_line(data = filter(minvol_sub1, ticker == "ADP"), aes(x = date, y = weight, color = "ADP"))  +
	geom_line(data = filter(minvol_sub1, ticker == "JNJ"), aes(x = date, y = weight, color = "JNJ"))  +
	geom_line(data = filter(minvol_sub1, ticker == "MCD"), aes(x = date, y = weight, color = "MCD"))  +
	xlab('date') + ylab('weight') + ggtitle('Average Weight Change of Top 5 Holdings in the Minimum Volatility Index')
```

``` {r fig.cap = paste("The 5 largest holdings of the Minimum Volatility Index are VZ, T, ADP, JNJ, and MCD. Since the index's inception, these stocks have generally remained between a weight of 1.3% and 1.7% of the overall portfolio, with the exception of Verizon, which reached around 2% in 2014."), echo=FALSE}
plot(holdings2)
```

## Change in Sector Weights Over Time
Sector weights were calculated over time for both the US Equal Weight and the Minimum Volatility Index. This was done to get a sense of what industries may be inherently more "low-risk" as well as checking to make sure the data is resilient, and each sector weighting in the Minimum Volatility Index is within 5% of the US Equal Weight Index, as specified by the Barra Optimizer. 

```{r, echo=FALSE}
load("~/thesis_final/data/usa_percent.Rda")
load("~/thesis_final/data/minvol_percent.Rda")
library(ggplot2)
```

``` {r fig.cap = paste("The weighting of energy in the US Equal Weight Index is consistently higher than the weighting in the Minimum Volatility Index. This might imply that energy is a more volatile industry when compared to others."), fig.height=3.5, fig.width=6.5, echo=FALSE}
## Energy
Eng1 <- usa_percent[which(usa_percent$sector_name=="Energy"), ]
Eng2 <- minvol_percent[which(minvol_percent$sector_name=="Energy"), ]
ggplot(Eng1, aes(date, percent, colour = "US Equal Weight")) + geom_line() +  
ggtitle("Index Energy Sector Weight Comparisons Over Time") + xlab("Time") + ylab("Sector Weight") +
geom_line(data = Eng2, aes(x=date, y=percent, colour="Minimum Volatility"),show.legend = TRUE)
```

``` {r fig.cap = paste("The weighting of financials in the US Equal Weight Index are pretty consistent until a significant decrease towards the latter half of 2016. In the Minimum Volatility Index, the weighting of financials fluctuate quite a bit, and experience a similar drop in weight at the same time as the US Equal Weight Index."), fig.height=3.5, fig.width=6.5, echo=FALSE}
## Financials
Fin1 <- usa_percent[which(usa_percent$sector_name=="Financials"), ]
Fin2 <- minvol_percent[which(minvol_percent$sector_name=="Financials"), ]
ggplot(Fin1, aes(date, percent, colour = "US Equal Weight")) + geom_line() + 
ggtitle("Index Financial Sector Weight Comparisons Over Time")+xlab("Time")+ylab("Sector Weight") + 
geom_line(data = Fin2, aes(x=date, y=percent, colour="Minimum Volatility"),show.legend = TRUE)
```

``` {r fig.cap = paste("The weighting of consumer staples in the US Equal Weight Index is consistently lower than the weighting of consumer staples in the Minimum Volatility Index. This might imply that consumer staples is a low volatile industry."), fig.height=3.5, fig.width=6.5, echo=FALSE}
## Consumer Staples
ConStap1 <- usa_percent[which(usa_percent$sector_name=="Consumer Staples"), ]
ConStap2 <- minvol_percent[which(minvol_percent$sector_name=="Consumer Staples"), ]
ggplot(ConStap1, aes(date, percent, colour = "US Equal Weight")) + geom_line() + 
ggtitle("Index Consumer Staples Sector Weight Comparisons Over Time") + xlab("Time") + 
ylab("Sector Weight") + geom_line(data = ConStap2, aes(x=date, y=percent, 
colour="Minimum Volatility"),show.legend = TRUE)
```

``` {r fig.cap = paste("The weight of consumer discretionary stocks is consistently higher in the US Equal Weight Index than in the Minimum Volatility Index. This might imply that consumer discretionary is inherently a volatile industry."), fig.height=3.5, fig.width=6.5, echo=FALSE}
## Consumer Discretionary
ConDis1 <- usa_percent[which(usa_percent$sector_name=="Consumer Discretionary"), ]
ConDis2 <- minvol_percent[which(minvol_percent$sector_name=="Consumer Discretionary"), ]
ggplot(ConDis1, aes(date, percent, colour = "US Equal Weight")) + geom_line() + 
ggtitle("Index Consumer Discretionary Sector Weight Comparisons Over Time") + xlab("Time") + 
ylab("Sector Weight") + geom_line(data = ConDis2, aes(x=date, y=percent, 
colour="Minimum Volatility"),show.legend = TRUE)
```

``` {r fig.cap = paste("The weight of healthcare stocks is consistently higher over time in the Minimum Volatility Index than in the US Equal Weight Index. This could imply that the healthcare sector may not be as volatile as other sectors."), fig.height=3.5, fig.width=6.5, echo=FALSE}
## Healthcare
Health1 <- usa_percent[which(usa_percent$sector_name=="Health Care"), ]
Health2 <- minvol_percent[which(minvol_percent$sector_name=="Health Care"), ]
ggplot(Health1, aes(date, percent, colour = "US Equal Weight")) + geom_line() + 
ggtitle("Index Healthcare Sector Weight Comparisons Over Time") + xlab("Time") + 
ylab("Sector Weight") + geom_line(data = Health2, aes(x=date, y=percent, 
colour="Minimum Volatility"),show.legend = TRUE)
```

``` {r fig.cap = paste("The weight of industrials is consistently higher over time in the US Equal Weight Index than in the Minimum Volatility Index. This could imply that industrial companies may be more volatile than companies in other sectors."), fig.height=3.5, fig.width=6.5, echo=FALSE}
## Industrials
Ind1 <- usa_percent[which(usa_percent$sector_name=="Industrials"), ]
Ind2 <- minvol_percent[which(minvol_percent$sector_name=="Industrials"), ]
ggplot(Ind1, aes(date, percent, colour = "US Equal Weight")) + geom_line() + 
ggtitle("Index Industrials Sector Weight Comparisons Over Time") + xlab("Time") + 
ylab("Sector Weight") + geom_line(data = Ind2, aes(x=date, y=percent, 
colour="Minimum Volatility"),show.legend = TRUE)
```

``` {r fig.cap = paste("The weighting of information technology stocks between 2012 and 2013 were significantly greater in the Minimum Volatility Index than in the US Equal Weight Index. However, since 2014, the weights of IT in both indices have converged, implying the industry may have more volatile over the last few years."), fig.height=3.5, fig.width=6.5, echo=FALSE}
## Information Technology
IT1 <- usa_percent[which(usa_percent$sector_name=="Information Technology"), ]
IT2 <- minvol_percent[which(minvol_percent$sector_name=="Information Technology"), ]
ggplot(IT1, aes(date, percent, colour = "US Equal Weight")) + geom_line() + 
ggtitle("Index Information Technology Sector Weight Comparisons Over Time") + 
xlab("Time") + ylab("Sector Weight") + geom_line(data = IT2, aes(x=date, y=percent,
colour="Minimum Volatility"),show.legend = TRUE)
```

``` {r fig.cap = paste("The weight of materials is consistently higher over time in the US Equal Weight Index than in the Minimum Volatility Index. This could imply that materials companies may be more volatile than companies in other sectors."), fig.height=3.5, fig.width=6.5, echo=FALSE}
## Materials
Mat1 <- usa_percent[which(usa_percent$sector_name=="Materials"), ]
Mat2 <- minvol_percent[which(minvol_percent$sector_name=="Materials"), ]
ggplot(Mat1, aes(date, percent, colour = "US Equal Weight")) + geom_line() + 
ggtitle("Index Materials Sector Weight Comparisons Over Time") + xlab("Time") + 
ylab("Sector Weight") + geom_line(data = Mat2, aes(x=date, y=percent, 
colour="Minimum Volatility"),show.legend = TRUE)
```

``` {r fig.cap = paste("The weight of utilities stocks is higher over time in the Minimum Volatility Index than in the US Equal Weight Index. This could imply that the utilities sector may not be as volatile as other sectors."), fig.height=3.5, fig.width=6.5, echo=FALSE}
## Utilities
Util1 <- usa_percent[which(usa_percent$sector_name=="Utilities"), ]
Util2 <- minvol_percent[which(minvol_percent$sector_name=="Utilities"), ]
ggplot(Util1, aes(date, percent, colour = "US Equal Weight")) + geom_line() + 
ggtitle("Index Utilities Sector Weight Comparisons Over Time") + xlab("Time") + 
ylab("Sector Weight") + geom_line(data = Util2, aes(x=date, y=percent, 
colour="Minimum Volatility"),show.legend = TRUE)
```

``` {r fig.cap = paste("The weight of telecommunications stocks is higher over time in the Minimum Volatility Index than in the US Equal Weight Index. However, over time the weight of telecommunications has consistently decreased, which would imply the industry has gotten more volatile over the past few years."), fig.height=3.5, fig.width=6.5, echo=FALSE}
## Telecommunication Services
Telecom1 <- usa_percent[which(usa_percent$sector_name=="Telecommunications"), ]
Telecom2 <- minvol_percent[which(minvol_percent$sector_name=="Telecommunications"), ]
ggplot(Telecom1, aes(date, percent, colour = "US Equal Weight")) + geom_line() + 
ggtitle("Index Telecommunication Sector Weight Comparisons Over Time") + 
xlab("Time") + ylab("Sector Weight") + geom_line(data = Telecom2, aes(x=date, 
y=percent, colour="Minimum Volatility"),show.legend = TRUE)
```

\clearpage 


## Trailing Volatility  
Data was collected from 10/31/2010 to 12/30/2016, from Wharton Research Data Services (WRDS) for the 908 historical constituents of the USA Equal Weight (EUSA) ETF, of which the Minimum Volatility Index is derived [@wrds2017]. Each tickers' 252-day (annual) trailing volatility was calculated, and a month end spaghetti plot was produced for stocks in the Minimum Volatility Index, and the remainder of the stock comprising the US Equal Weight Index, to get a relative sense of each group's volatility attributes. The stocks comprising the Minimum Volatility Index generally had a lower volatility than those in the US Equal Weight Index.

```{r, echo = FALSE}
library(ggplot2)
load("~/thesis_final/data/monthly_data.Rda")

usa_vol <-filter(monthly_data, index_now == 0)
summary(usa_vol$volatility)

us_volplot <- ggplot(usa_vol, aes(date, volatility, group = ticker)) + geom_line() + ggtitle("52-Week Trailing Volatility for Stocks in the US Equal Weight Index") + labs(x="Date", y="52-week Trailing Volatility")
```

``` {r fig.cap = paste("The 52-week trailing volatilities for stocks in the US Equal Weight Index ranged from 0.00492 to 87.37030, with a mean value of 1.44738."), echo=FALSE}
plot(us_volplot)
```

```{r, echo = FALSE}
library(ggplot2)
load("~/thesis_final/data/monthly_data.Rda")

minvol_vol <-filter(monthly_data, index_now == 1)
summary(minvol_vol$volatility)

minvol_volplot <- ggplot(minvol_vol, aes(date, volatility, group = ticker)) + geom_line() + ggtitle("52-Week Trailing Volatility for Stocks in the Minimum Volatility Index") + labs(x="Date", y="52-week Trailing Volatility")
```

``` {r fig.cap = paste("The 52-week trailing volatilities for stocks in the Minimum Volatility Index ranged from 0.03085 to 34.20974, with a mean value of 1.40784."), echo=FALSE}
plot(minvol_volplot)
```

## Trailing Beta 
Data was collected from 10/31/2010 to 12/30/2016, from Wharton Research Data Services (WRDS) for the 908 historical constituents of the USA Equal Weight (EUSA) ETF, of which the Minimum Volatility Index is derived [@wrds2017]. Each tickers' 252-day (annual) trailing beta was calculated, and a month end spaghetti plot was produced for stocks in the Minimum Volatility Index, and the remainder of the stock comprising the US Equal Weight Index, to get a relative sense of each group's volatility attributes. Generally, the stocks comprising the Minimum Volatility Index had a lower beta than those in the US Equal Weight Index.

```{r, echo = FALSE}
library(ggplot2)
load("~/thesis_final/data/monthly_data.Rda")

usa_beta <-filter(monthly_data, index_now == 0)
summary(usa_beta$beta)

usa_beta_plot <- ggplot(usa_beta, aes(date, beta, group = ticker)) + geom_line() + ggtitle("52-Week Trailing Beta for Stocks in the US Equal Weight Index") + labs(x="Date", y="52-week Trailing Beta")
```

``` {r fig.cap = paste("The 52-week trailing betas for stocks in the US Equal Weight Index ranged from -4.9037 to 6.4952, with a mean value of 1.1505"), echo=FALSE}
plot(usa_beta_plot)
```

```{r, echo = FALSE}
library(ggplot2)
load("~/thesis_final/data/monthly_data.Rda")

minvol_beta <-filter(monthly_data, index_now == 1)
summary(minvol_beta$beta)

minvol_beta_plot <- ggplot(minvol_beta, aes(date, beta, group = ticker)) + geom_line() + ggtitle("52-Week Trailing Beta for Stocks in the Minimum Volatility Index") + labs(x="Date", y="52-week Trailing Beta")
```

``` {r fig.cap = paste("The 52-week trailing betas for stocks in the Minimum Volatility Index ranged from -0.2473 to 3.2021, with a mean value of 0.7856"), echo=FALSE}
plot(minvol_beta_plot)
```


